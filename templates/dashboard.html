<!DOCTYPE html>
<html>

<head>
    <title>Flask App</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" />

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='global.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='dashboard.css') }}">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css" />
</head>

<body>
    <div class="header">
        <span class="title">Header</span>
    </div>

    <div class="content">
        <div class="projects">
            {% for file in files %}
            {% include 'flp.html' %}
            {% endfor %}
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get all the spans with class name "modified_at"
        const modifiedAtSpans = document.querySelectorAll('.modified_at');

        // Convert epochs to the most logical time units and handle singular/plural
        modifiedAtSpans.forEach(span => {
            const epoch = parseInt(span.textContent);
            if (!isNaN(epoch)) {
                const now = Math.floor(Date.now() / 1000);
                const secondsAgo = now - epoch;

                let timeAgo;
                if (secondsAgo < 60) { // less than 1 minute
                    timeAgo = 'just now';
                } else if (secondsAgo < 3600) { // less than 1 hour
                    const minutes = Math.floor(secondsAgo / 60);
                    timeAgo = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                } else if (secondsAgo < 86400) { // less than 1 day
                    const hours = Math.floor(secondsAgo / 3600);
                    timeAgo = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                } else if (secondsAgo < 604800) { // less than 1 week
                    const days = Math.floor(secondsAgo / 86400);
                    timeAgo = `${days} day${days > 1 ? 's' : ''} ago`;
                } else if (secondsAgo < 2629746) { // less than 1 month (approximately)
                    const weeks = Math.floor(secondsAgo / 604800);
                    timeAgo = `${weeks} week${weeks > 1 ? 's' : ''} ago`;
                } else if (secondsAgo < 31556952) { // less than 1 year (approximately)
                    const months = Math.floor(secondsAgo / 2629746);
                    timeAgo = `${months} month${months > 1 ? 's' : ''} ago`;
                } else { // 1 year or more
                    const years = Math.floor(secondsAgo / 31556952);
                    timeAgo = `${years} year${years > 1 ? 's' : ''} ago`;
                }

                span.textContent = timeAgo;
            } else {
                console.error('Invalid epoch time:', span.textContent);
            }
        });
    });
</script>

<script>
    tippy('.icon-tempo', {
        content: 'Tempo',
        placement: 'bottom',
        theme: 'light',
        animation: 'scale',
        arrow: true,
        duration: 200
    })

    tippy('.icon-channels', {
        content: 'Channels',
        placement: 'bottom',
        theme: 'light',
        animation: 'scale',
        arrow: true,
        duration: 200
    })

    tippy('.icon-last-modified', {
        content: 'Last Modified',
        placement: 'bottom',
        theme: 'light',
        animation: 'scale',
        arrow: true,
        duration: 200
    })

    tippy('.icon-running-time', {
        content: 'Playlist Running Time',
        placement: 'bottom',
        theme: 'light',
        animation: 'scale',
        arrow: true,
        duration: 200
    })

    tippy('.action.delete', {
        content: 'Delete',
        placement: 'bottom',
        theme: 'light',
        animation: 'scale',
        arrow: true,
        duration: 200
    })

    tippy('.action.folder-open', {
        content: 'Open Folder',
        placement: 'bottom',
        theme: 'light',
        animation: 'scale',
        arrow: true,
        duration: 200
    })

    tippy('.action.open', {
        content: 'Open',
        placement: 'bottom',
        theme: 'light',
        animation: 'scale',
        arrow: true,
        duration: 200
    })
</script>

<script>

    document.querySelectorAll('.action.folder-open').forEach(action => {
        action.addEventListener('click', () => {
            const project = action.closest('.project');
            const projectPath = project.getAttribute('project_path');
            const folderPath = projectPath.substring(0, projectPath.lastIndexOf('/'));

            fetch('/open-folder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    folder_path: folderPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Folder opened:', projectPath);
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        });
    });

    document.querySelectorAll('.action.open').forEach(action => {
        action.addEventListener('click', () => {
            const project = action.closest('.project');
            const projectPath = project.getAttribute('project_path');

            fetch('/open-project', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    project_path: projectPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Project opened:', projectPath);
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        });
    });

    tippy('.color-bar', {
        content: `
    <div class="color-picker">
        <div class="color" data-color="blue" style="background-color: var(--color-blue);"></div>
        <div class="color" data-color="green" style="background-color: var(--color-green);"></div>
        <div class="color" data-color="red" style="background-color: var(--color-red);"></div>
        <div class="color" data-color="yellow" style="background-color: var(--color-yellow);"></div>
        <div class="color" data-color="grey" style="background-color: var(--color-grey);"></div>
        <div class="color" data-color="purple" style="background-color: var(--color-purple);"></div>
        <div class="color" data-color="orange" style="background-color: var(--color-orange);"></div>
        <div class="color" data-color="pink" style="background-color: var(--color-pink);"></div>
        <div class="color" data-color="cyan" style="background-color: var(--color-cyan);"></div>
        <div class="color" data-color="teal" style="background-color: var(--color-teal);"></div>
        <div class="color" data-color="lime" style="background-color: var(--color-lime);"></div>
        <div class="color" data-color="amber" style="background-color: var(--color-amber);"></div>
    </div>
    `,
        placement: 'bottom',
        theme: 'light',
        animation: 'scale',
        arrow: true,
        duration: 200,
        interactive: true,
        trigger: 'click',
        allowHTML: true,
        onShown(instance) {
            instance.popper.querySelectorAll('.color').forEach(color => {
                color.addEventListener('click', () => {
                    const project = instance.reference.closest('.project');
                    const colorBar = project.querySelector('.color-bar');
                    const colorName = color.getAttribute('data-color');

                    colorBar.style.backgroundColor = `var(--color-${colorName})`;

                    fetch('/change-color', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            project_id: project.getAttribute('project_id'),
                            color: colorName
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('Color changed:', colorName);
                            }
                        })
                        .catch(error => {
                            console.error('Error changing color:', error);
                        });
                });
            });
        }
    });

</script>